version: '2.4'

services:
  mysql-slowlog-analyzer:
    build: .
    container_name: mysql_slowlog_analyzer
    restart: unless-stopped
    
    # 环境变量
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      # MySQL慢日志配置
      - SLOWLOG_PATH=/app/slowlogs/*.log
      - TOP_DAILY=30
      - TOP_WEEKLY=50
      - TOP_MONTHLY=100
      - MIN_TIME=1.0
      - JOBS=4
      - EXCLUDE_DUMPS=true
      # Elasticsearch配置（需要在.env文件中配置）
      - ES_HOST=${ES_HOST}
      - ES_USER=${ES_USER}
      - ES_PASSWORD=${ES_PASSWORD}
      - HOSTNAME=${ANALYZER_HOSTNAME:-mysql-slowlog-analyzer}
    
    # 目录挂载
    volumes:
      # 慢日志文件目录（只读）
      - ./slowlogs:/app/slowlogs:ro
      # 分析结果输出目录
      - ./output:/app/output
      # 运行日志目录
      - ./logs:/app/logs
    
    # 资源限制（2.4版本格式）
    mem_limit: 2g
    cpus: 2.0
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
